<html>
	<head>
		<link rel="stylesheet" type="text/css" href="../css/tester.css"/>
		<style>
		.point {
			position: absolute;
			top: 0;
			left: 0;
			z-index: 20;
		}
		</style>
		<script src="../lib/curl.js"></script>
		<script>
			// some <script data-main=""> semantics to reduce this boilerplate?
			require = curl;
			require({
				baseUrl: '..',
				paths: {
					assets: '../assets'
				}
			}, [
				'lib/lang',
				'lib/compose',
				'lib/promise',
				'lib/state',
				'lib/Evented',
				'lib/loop'
			], function(lang, Compose, Promise, Stateful, Evented, loop){

				var after = Compose.after, 
					before = Compose.before, 
					from = Compose.from;

				var _Node = Compose(Compose, {
					addChild: function(thing){
						thing.init && thing.init(this);
						this.children.push(thing);
						return this;
					},
					removeChild: function(thing){
						thing.uninit && thing.uninit();
						this.children.remove(thing);
						return thing;
					},
					getParent: function(){
						return this._parent;
					}, 
					init: function(parent){
						this._parent = parent;
						return this;
					}
				}, function(){
					this.children = new lang.KeyedArray;
				});
				
				var world = game = Compose.create(_Node, function(){
					console.log("game ctor");
					var defaultSequence = [
						"init", 
						"loadContent", 
						"run"
					];
					var self = this;

					this.start = function(){
						this.sequence = new Promise.Sequence(
							defaultSequence.map(function(name){
								return lang.bind(self, name)
							})
						);
						this.sequence.next();
					};
				}, {
					init: after(function(parent){
						this.clock = new loop.Loop({
							id: "clock",
							update: lang.bind(this, this.update),
							redraw: lang.bind(this, this.render),
						});
						
						this.stageNode = document.getElementById("playarea");
						this.timeNode = document.getElementById("timestamp");
						
						this.renderQueue = [];

						this.addChild(
							{ id: "physics" }
						);
						this.addChild(
							{ id: "path-finding" }
						);

						console.log("adding creep");
						game.addChild((new Creep));
						console.log("/adding creep");

						
					}),
					loadContent: function(){
						console.log("loading assets");
					},
					run: function(){
						console.log("start clock if we have one");
						console.log("kick off the update cycle");
						this.clock.startLoop();
					},
					update: function(){
						this.renderQueue = [];
						this.timestamp = +new Date;
						// walk the graph
						this._walkCollection(this.children)
					},
					_walkCollection: function(children){
						var renderQ = this.renderQueue, 
							node = null;
						for(var i=0, len=children.length; i<len; i++){
							node = children[i];
							// recurse on node's children
							// bottom up - update children then parents
							if(node.children && node.children.length){
								this._walkCollection(node.children);
							}
							if("function" == typeof node.update){
								node.update();
							}
							if("function" == typeof node.render){
								renderQ.push(node);
							}
						}
					},
					render: function(){
						var renderQ = this.renderQueue, 
							ent = null;
						while((ent = renderQ.pop())){
							ent.render();
						};
						this.timeNode.innerHTML = this.timestamp;
					},
					shutdown: function(){
						this.clock.stopLoop();
					}
				});
				
				var Creep = Compose(_Node, {
					x: 0, 
					y: 0,
					type: "creep",
					init: after(function(){
						console.log("Creep init");
						var node = this.domNode = document.createElement("div");
						node.className = "static-spot point";
						game.stageNode.appendChild(node);
						
						this.addChild(sineWave);
					}),
					render: function(){
						this.domNode.style.left = this.x +"px";
						this.domNode.style.top = (90+this.y) +"px";
						// console.log("Creep render: ", this.x, this.y, this.domNode.style.cssText);
					}
				}, function(){
					console.log("creep ctor");
					this.children = [];
				});
				
				var sineWave = Compose.create(_Node, {
					y: 0,
					x: 0,
					type: "sine-wave",
					update: function(){
						var y = this.y,
							x = this.x;
						this._parent.x = x;
						this._parent.y = 50 * Math.sin(y);
						this.y = y >= 100 ? 0 : y+0.1;
						this.x = x >= 800 ? 0 : x+4;
						// console.log("sineWave: ", this._parent.x, this._parent.y);
					}
				})

				game.start();
				setTimeout(function(){
					game.shutdown()
				}, 12000);
			}); 
		</script>
	</head>
	<body style="margin:0;padding:0;">
		<div id="playarea" style="height: 200px; margin-right:10px;">
			<div id="timestamp"></div>
		</div>
		<input type="button" value="start" onclick="game.start();">
		&nbsp;
		<input type="button" value="stop" onclick="game.shutdown('ended');">
		&nbsp;
		<input type="button" value="menu mode" onclick="game.enterState('menu');">
	</body>
</html>
